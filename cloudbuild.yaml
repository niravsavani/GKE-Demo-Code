steps:

 - name: 'gcr.io/cloud-builders/docker'
   args: ['build','-t','gcr.io/${_PROJECT}/${_CONTAINERNAME}:${_VERSION}','.']

 - name: 'gcr.io/cloud-builders/docker'
   args: ['push','gcr.io/${_PROJECT}/${_CONTAINERNAME}:${_VERSION}']

 - name: 'omegaes/kubci'
   args: ['$SHORT_SHA']
   secretEnv: ['ENV_REPO_URL']
   env:
    - 'ENV_REPO_FILES=$_ENV_REPO_FILES'
    - 'ENV_REPO_MERGE_BRANCH=$_ENV_REPO_MERGE_BRANCH'
    - 'ENV_REPO_TARGET_BRANCH=$_ENV_REPO_TARGET_BRANCH'
    - 'REPO_NAME=$REPO_NAME'
    - 'BRANCH_NAME=$BRANCH_NAME'

substitutions:
    #GCP Specific configuration. Please DON'T change anything
    _PROJECT: argocd-352710
    _ZONE: us-central1-a
    _CONTAINERNAME: hello-world-service 

availableSecrets:
    secretManager:
    - versionName: projects/150435548913/secrets/ENV_REPO_AUTH_URL/versions/1
      env: 'ENV_REPO_URL'

options:
  logging: CLOUD_LOGGING_ONLY
timeout: 720s
tags: ['masterBuild', 'ApiV3Build']
